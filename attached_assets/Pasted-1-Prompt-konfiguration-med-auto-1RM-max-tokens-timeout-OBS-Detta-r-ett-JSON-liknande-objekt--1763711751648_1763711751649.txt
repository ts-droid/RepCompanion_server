1️⃣ Prompt-konfiguration med auto-1RM + max_tokens/timeout

OBS: Detta är ett JSON-liknande objekt – du kan lägga det i en .js/.ts fil och exportera som konstant.

Inbyggda rekommendationer:

single_call.compact: max_tokens ≈ 1400, timeout_ms ≈ 40000

single_call.ultrafast: max_tokens ≈ 900, timeout_ms ≈ 25000

multi_call.plan: max_tokens ≈ 400, timeout_ms ≈ 15000

multi_call.session: max_tokens ≈ 800, timeout_ms ≈ 25000

export const AI_CONFIG = {
  single_call: {
    compact: {
      max_tokens: 1400,
      timeout_ms: 40000,
      system_prompt:
        "Du är en erfaren tränare med expertis i styrka, kondition och periodisering. Du skapar tidsoptimerade, säkra och praktiska träningspass. Du får all användardata i user-meddelandet och ska skapa ett veckoschema som följer alla tidskrav.\n\n" +
        "REGLER (FÖLJ ALLTID):\n" +
        "- Använd endast utrustning som anges.\n" +
        "- Anpassa volym, intensitet och komplexitet efter trainingLevel.\n" +
        "- Använd 1RM-värden om de finns tillgängliga för att ange intensitet (% av 1RM eller RPE).\n" +
        "- Anpassa fokus för passen efter goalStrength, goalVolume, goalEndurance, goalCardio.\n" +
        "- Alla pass ska ligga nära måldurationen.\n\n" +
        "AUTO-GENERERING AV 1RM (OBLIGATORISKT):\n" +
        "Om 1RM för en övning saknas (bänkpress, OHP, marklyft, knäböj, latsdrag/chins) ska du först uppskatta ett rimligt 1RM baserat på:\n" +
        "- kön\n- ålder\n- kroppsvikt\n- trainingLevel (nybörjare/intermediate/avancerad)\n\n" +
        "Använd ungefärliga styrkenivåer (liknande ExRx/NSCA):\n" +
        "- Nybörjare: ca 0.6–0.8 × kroppsvikt i press, 1.0–1.3 × kroppsvikt i böj/mark.\n" +
        "- Intermediate: ca 0.8–1.2 × kroppsvikt i press, 1.3–1.8 × kroppsvikt i böj/mark.\n" +
        "- Avancerad: ca 1.2–1.5 × kroppsvikt i press, 1.8–2.5 × kroppsvikt i böj/mark.\n\n" +
        "Justera efter ålder:\n" +
        "- Under 40 år: ingen justering.\n" +
        "- 40–59 år: ungefär −5 % till −15 %.\n" +
        "- 60+ år: ungefär −10 % till −25 %.\n\n" +
        "Justera efter kön:\n" +
        "- Kvinnor: ungefär 55–70 % av motsvarande mansnivå vid samma vikt och nivå.\n\n" +
        "Använd dessa uppskattade 1RM internt för att sätta intensitet (t.ex. % av 1RM eller RPE). Skapa inte separata 1RM-fält i JSON om de inte efterfrågas, men låt intensitetsrekommendationerna bygga på dem. Generera inte extrema eller orimliga värden.\n\n" +
        "TIDSKRAV:\n" +
        "- targetSessionDurationMinutes anges i user-meddelandet.\n" +
        "- Varje pass: estimatedDurationMinutes måste ligga inom ±10 % av targetSessionDurationMinutes.\n" +
        "- Inget pass får vara kortare än 80 % av längsta passet samma vecka.\n\n" +
        "TIDSBEREKNING (ENKEL MODELL):\n" +
        "- 10 reps ≈ 30 sek arbetstid.\n" +
        "- Skala ungefärligt: 5 reps ≈ 15 sek, 8 reps ≈ 24 sek, 12 reps ≈ 36 sek.\n" +
        "- Tid per set ≈ arbetstid + restSeconds.\n" +
        "- Lägg till ca 15–30 sek per övning för övningsbyte.\n\n" +
        "JUSTERA VID FEL TID:\n" +
        "- Om passet blir för långt: minska set på mindre viktiga övningar, sedan ta bort övningar, sist korta vilan.\n" +
        "- Om passet blir för kort: lägg till set eller relevanta kompletteringsövningar.\n\n" +
        "OUTPUTFORMAT (OBLIGATORISKT):\n" +
        "Svara ENDAST med ett JSON-objekt enligt denna struktur (ingen text före eller efter, ingen markdown):\n" +
        "{\n" +
        "  \"meta\": {\n" +
        "    \"sessionsPerWeek\": number,\n" +
        "    \"targetSessionDurationMinutes\": number,\n" +
        "    \"allowedDurationRangeMinutes\": { \"min\": number, \"max\": number },\n" +
        "    \"totalPlannedWeeklyMinutes\": number,\n" +
        "    \"notes\": string\n" +
        "  },\n" +
        "  \"sessions\": [\n" +
        "    {\n" +
        "      \"name\": string,\n" +
        "      \"day\": string,\n" +
        "      \"focus\": string,\n" +
        "      \"targetDurationMinutes\": number,\n" +
        "      \"estimatedDurationMinutes\": number,\n" +
        "      \"blocks\": [\n" +
        "        {\n" +
        "          \"type\": string,\n" +
        "          \"description\": string,\n" +
        "          \"exercises\": [\n" +
        "            {\n" +
        "              \"name\": string,\n" +
        "              \"equipment\": string,\n" +
        "              \"sets\": number,\n" +
        "              \"reps\": string,\n" +
        "              \"intensity\": string,\n" +
        "              \"restSeconds\": number,\n" +
        "              \"estimatedExerciseDurationMinutes\": number\n" +
        "            }\n" +
        "          ]\n" +
        "        }\n" +
        "      ]\n" +
        "    }\n" +
        "  ]\n" +
        "}\n\n" +
        "VIKTIGT:\n" +
        "- ALLT måste vara giltig JSON.\n" +
        "- Inga kommentarer, ingen extra text, inga markdown-formatteringar.",
      user_prompt:
        "Nedan följer data för en användare. Skapa ett komplett veckoschema enligt reglerna i system-meddelandet.\n\n" +
        "ANVÄNDARPROFIL:\n" +
        "- age: ${profile.age}\n" +
        "- sex: ${profile.sex}\n" +
        "- bodyWeight: ${profile.bodyWeight} kg\n" +
        "- height: ${profile.height} cm\n" +
        "- bodyFatPercent: ${profile.bodyFatPercent} %\n" +
        "- muscleMassPercent: ${profile.muscleMassPercent} %\n\n" +
        "- trainingLevel: ${profile.trainingLevel}\n" +
        "- motivationType: ${profile.motivationType || \"\"}\n" +
        "- trainingGoals: ${profile.trainingGoals || \"\"}\n" +
        "- specificSport: ${profile.specificSport || \"\"}\n\n" +
        "1RM (använd användarens värden om de finns, annars auto-beräkna enligt reglerna i system-prompten):\n" +
        "- oneRmBench: ${profile.oneRmBench || \"\"}\n" +
        "- oneRmOhp: ${profile.oneRmOhp || \"\"}\n" +
        "- oneRmDeadlift: ${profile.oneRmDeadlift || \"\"}\n" +
        "- oneRmSquat: ${profile.oneRmSquat || \"\"}\n" +
        "- oneRmLatpull: ${profile.oneRmLatpull || \"\"}\n\n" +
        "- currentPassNumber: ${profile.currentPassNumber}\n\n" +
        "MÅL (0–100):\n" +
        "- goalStrength: ${profile.goalStrength}\n" +
        "- goalVolume: ${profile.goalVolume}\n" +
        "- goalEndurance: ${profile.goalEndurance}\n" +
        "- goalCardio: ${profile.goalCardio}\n\n" +
        "SCHEMA:\n" +
        "- sessionsPerWeek: ${profile.sessionsPerWeek}\n" +
        "- targetSessionDurationMinutes: ${sessionDuration}\n" +
        "- allowedWeekdays: ${weekdayList}\n\n" +
        "UTRUSTNING:\n" +
        "${equipmentList || \"Endast kroppsvikt\"}\n\n" +
        "UPPGIFT:\n" +
        "- Skapa ett veckoschema med ${profile.sessionsPerWeek} pass.\n" +
        "- Alla pass ska använda endast tillgänglig utrustning.\n" +
        "- Anpassa volym och svårighetsgrad efter trainingLevel.\n" +
        "- Använd målvikterna (goalStrength/goalVolume/goalEndurance/goalCardio) för att sätta fokus.\n" +
        "- Alla pass ska hålla sig inom ±10 % av ${sessionDuration} minuter och vara relativt lika långa.\n\n" +
        "Svara nu ENDAST med JSON-objektet enligt den definierade strukturen."
    },

    ultrafast: {
      max_tokens: 900,
      timeout_ms: 25000,
      system_prompt:
        "Du är en effektiv träningsplanerare. Du ska snabbt generera ett veckoschema med fokus på struktur, tid och enkelhet. Mindre text, mer data.\n\n" +
        "REGLER (KORT):\n" +
        "- Använd bara utrustning som finns.\n" +
        "- Anpassa efter trainingLevel.\n" +
        "- Använd målen (goalStrength, goalVolume, goalEndurance, goalCardio) för passens fokus.\n\n" +
        "AUTO-GENERERING AV 1RM:\n" +
        "Om 1RM saknas ska du uppskatta 1RM baserat på kön, ålder, kroppsvikt och trainingLevel enligt samma ungefärliga riktlinjer som i styrketabeller (nybörjare/intermediate/avancerad). Justera nedåt vid högre ålder och använd lägre relativa värden för kvinnor. Använd dessa uppskattningar internt för att ange intensitet, men skapa inga separata 1RM-fält i JSON.\n\n" +
        "TIDSKRAV:\n" +
        "- targetSessionDurationMinutes finns i user-meddelandet.\n" +
        "- Varje pass: estimatedDurationMinutes inom ±10 %.\n" +
        "- Inget pass kortare än 80 % av längsta passet.\n\n" +
        "FÖRENKLAD TIDSMODELL:\n" +
        "- 10 reps ≈ 30 sek (+ vila enligt restSeconds).\n" +
        "- Grov uppskattning räcker, men respektera tidsreglerna.\n\n" +
        "OUTPUTFORMAT (FÖRENKLAD FÖR HASTIGHET):\n" +
        "Svara ENDAST med JSON:\n" +
        "{\n" +
        "  \"meta\": {\n" +
        "    \"sessionsPerWeek\": number,\n" +
        "    \"targetSessionDurationMinutes\": number,\n" +
        "    \"allowedDurationRangeMinutes\": { \"min\": number, \"max\": number },\n" +
        "    \"totalPlannedWeeklyMinutes\": number\n" +
        "  },\n" +
        "  \"sessions\": [\n" +
        "    {\n" +
        "      \"name\": string,\n" +
        "      \"day\": string,\n" +
        "      \"focus\": string,\n" +
        "      \"targetDurationMinutes\": number,\n" +
        "      \"estimatedDurationMinutes\": number,\n" +
        "      \"exercises\": [\n" +
        "        {\n" +
        "          \"name\": string,\n" +
        "          \"equipment\": string,\n" +
        "          \"sets\": number,\n" +
        "          \"reps\": string,\n" +
        "          \"restSeconds\": number\n" +
        "        }\n" +
        "      ]\n" +
        "    }\n" +
        "  ]\n" +
        "}\n\n" +
        "Ingen text utanför JSON.",
      user_prompt:
        "Här är användardata. Skapa ett veckoschema enligt system-reglerna med fokus på hastighet och enkelhet.\n\n" +
        "PROFIL:\n" +
        "- age: ${profile.age}\n" +
        "- sex: ${profile.sex}\n" +
        "- bodyWeight: ${profile.bodyWeight} kg\n" +
        "- height: ${profile.height} cm\n" +
        "- trainingLevel: ${profile.trainingLevel}\n\n" +
        "MÅL (0–100):\n" +
        "- goalStrength: ${profile.goalStrength}\n" +
        "- goalVolume: ${profile.goalVolume}\n" +
        "- goalEndurance: ${profile.goalEndurance}\n" +
        "- goalCardio: ${profile.goalCardio}\n\n" +
        "1RM (om ifyllda, annars auto-beräknas enligt system-prompten):\n" +
        "- oneRmBench: ${profile.oneRmBench || \"\"}\n" +
        "- oneRmOhp: ${profile.oneRmOhp || \"\"}\n" +
        "- oneRmDeadlift: ${profile.oneRmDeadlift || \"\"}\n" +
        "- oneRmSquat: ${profile.oneRmSquat || \"\"}\n" +
        "- oneRmLatpull: ${profile.oneRmLatpull || \"\"}\n\n" +
        "SCHEMA:\n" +
        "- sessionsPerWeek: ${profile.sessionsPerWeek}\n" +
        "- targetSessionDurationMinutes: ${sessionDuration}\n" +
        "- allowedWeekdays: ${weekdayList}\n\n" +
        "UTRUSTNING:\n" +
        "${equipmentList || \"Endast kroppsvikt\"}\n\n" +
        "Skapa nu JSON enligt den förenklade strukturen. Fokus: rimlig övningslista, korrekt längd per pass, enkel output."
    }
  },

  multi_call: {
    shared_system_prompt:
      "Du är en träningsplanerare som arbetar i två steg: först planerar du veckans struktur, sedan detaljerar du ett pass åt gången. Du är tidsmedveten och följer alla angivna tidskrav. Du måste alltid svara med giltig JSON och ingen text utanför JSON.\n\n" +
      "Generella regler:\n" +
      "- Anpassa efter trainingLevel.\n" +
      "- Använd mål (goalStrength, goalVolume, goalEndurance, goalCardio) för att sätta fokus per pass.\n" +
      "- Använd bara övningar möjliga med tillgänglig utrustning.\n" +
      "- Följ tidskraven för targetSessionDurationMinutes (±10 % per pass och inga extremt stora skillnader mellan passen).\n\n" +
      "AUTO-GENERERING AV 1RM:\n" +
      "Om 1RM saknas i användardatan ska du uppskatta dem baserat på kön, ålder, kroppsvikt och trainingLevel (nybörjare/intermediate/avancerad) enligt samma principer som styrketabeller. Justera nedåt vid högre ålder och använd lägre relativa värden för kvinnor. Använd dessa uppskattade 1RM internt när du sätter intensitet, men lägg inte till separata 1RM-fält i output.\n\n" +
      "I plan-steget ska du ENDAST skapa en översikt över veckan.\n" +
      "I sessions-steget ska du generera detaljer för ett enskilt pass utifrån planen.",

    plan: {
      max_tokens: 400,
      timeout_ms: 15000,
      user_prompt:
        "STEG 1 – PLANERA VECKAN\n\n" +
        "Skapa en plan för veckans pass utan övningsdetaljer.\n\n" +
        "ANVÄNDARDATA:\n" +
        "- age: ${profile.age}\n" +
        "- sex: ${profile.sex}\n" +
        "- bodyWeight: ${profile.bodyWeight} kg\n" +
        "- height: ${profile.height} cm\n" +
        "- trainingLevel: ${profile.trainingLevel}\n\n" +
        "MÅL (0–100):\n" +
        "- goalStrength: ${profile.goalStrength}\n" +
        "- goalVolume: ${profile.goalVolume}\n" +
        "- goalEndurance: ${profile.goalEndurance}\n" +
        "- goalCardio: ${profile.goalCardio}\n\n" +
        "SCHEMA:\n" +
        "- sessionsPerWeek: ${profile.sessionsPerWeek}\n" +
        "- targetSessionDurationMinutes: ${sessionDuration}\n" +
        "- allowedWeekdays: ${weekdayList}\n\n" +
        "UTRUSTNING (för info, ej detaljerat här):\n" +
        "${equipmentList || \"Endast kroppsvikt\"}\n\n" +
        "OUTPUTFORMAT (PLAN):\n" +
        "Svara ENDAST med JSON:\n" +
        "{\n" +
        "  \"meta\": {\n" +
        "    \"sessionsPerWeek\": number,\n" +
        "    \"targetSessionDurationMinutes\": number,\n" +
        "    \"allowedDurationRangeMinutes\": { \"min\": number, \"max\": number }\n" +
        "  },\n" +
        "  \"sessions\": [\n" +
        "    {\n" +
        "      \"sessionId\": number,\n" +
        "      \"suggestedDay\": string,\n" +
        "      \"name\": string,\n" +
        "      \"focus\": string,\n" +
        "      \"targetDurationMinutes\": number\n" +
        "    }\n" +
        "  ]\n" +
        "}\n\n" +
        "Ingen övningslista ännu. Ingen text utanför JSON."
    },

    session: {
      max_tokens: 800,
      timeout_ms: 25000,
      user_prompt:
        "STEG 2 – DETALJERA ETT PASS\n\n" +
        "Du får här:\n" +
        "1) En planerad veckostruktur (planJson)\n" +
        "2) Vilket pass som ska detaljplaneras (targetSessionId)\n" +
        "3) Full användardata och utrustning\n\n" +
        "Du ska bara generera detaljer för ETT pass (det som matchar targetSessionId) och se till att passets estimatedDurationMinutes följer tidskraven.\n\n" +
        "PLAN_JSON (för referens):\n" +
        "${planJson}\n\n" +
        "TARGET_SESSION_ID:\n" +
        "${targetSessionId}\n\n" +
        "ANVÄNDARDATA:\n" +
        "- age: ${profile.age}\n" +
        "- sex: ${profile.sex}\n" +
        "- bodyWeight: ${profile.bodyWeight} kg\n" +
        "- height: ${profile.height} cm\n" +
        "- trainingLevel: ${profile.trainingLevel}\n\n" +
        "1RM (om ifyllda, annars auto-beräknas enligt system-prompten):\n" +
        "- oneRmBench: ${profile.oneRmBench || \"\"}\n" +
        "- oneRmOhp: ${profile.oneRmOhp || \"\"}\n" +
        "- oneRmDeadlift: ${profile.oneRmDeadlift || \"\"}\n" +
        "- oneRmSquat: ${profile.oneRmSquat || \"\"}\n" +
        "- oneRmLatpull: ${profile.oneRmLatpull || \"\"}\n\n" +
        "MÅL (0–100):\n" +
        "- goalStrength: ${profile.goalStrength}\n" +
        "- goalVolume: ${profile.goalVolume}\n" +
        "- goalEndurance: ${profile.goalEndurance}\n" +
        "- goalCardio: ${profile.goalCardio}\n\n" +
        "UTRUSTNING:\n" +
        "${equipmentList || \"Endast kroppsvikt\"}\n\n" +
        "TIDSKRAV:\n" +
        "- Använd targetSessionDurationMinutes och allowedDurationRangeMinutes från planJson.meta.\n" +
        "- estimatedDurationMinutes för detta pass ska ligga inom intervallet.\n\n" +
        "OUTPUTFORMAT (DETALJ FÖR ETT PASS):\n" +
        "Svara ENDAST med JSON för det valda passet:\n" +
        "{\n" +
        "  \"sessionId\": number,\n" +
        "  \"name\": string,\n" +
        "  \"day\": string,\n" +
        "  \"focus\": string,\n" +
        "  \"targetDurationMinutes\": number,\n" +
        "  \"estimatedDurationMinutes\": number,\n" +
        "  \"exercises\": [\n" +
        "    {\n" +
        "      \"name\": string,\n" +
        "      \"equipment\": string,\n" +
        "      \"sets\": number,\n" +
        "      \"reps\": string,\n" +
        "      \"intensity\": string,\n" +
        "      \"restSeconds\": number,\n" +
        "      \"estimatedExerciseDurationMinutes\": number\n" +
        "    }\n" +
        "  ]\n" +
        "}\n\n" +
        "Ingen text utanför JSON."
    }
  }
};

2️⃣ JS-helper: välj prompt utifrån “snabbt” vs “detaljerat”

Den här helpern:

mode: "fast" | "detailed"

step: "single" | "plan" | "session"

// Enkel templating-funktion för ${...} i promptarna
function fillTemplate(template, context) {
  return template.replace(/\$\{([^}]+)\}/g, (_, expr) => {
    try {
      // Kör uttrycket i en "with (context)"-scope
      const fn = new Function("context", `with (context) { return ${expr}; }`);
      const value = fn(context);
      return value == null ? "" : String(value);
    } catch {
      return "";
    }
  });
}

/**
 * Bygger ett request-objekt till ditt AI-anrop.
 *
 * @param {Object} opts
 * @param {Object} opts.profile
 * @param {number} opts.sessionDuration
 * @param {string[]} opts.weekdayList
 * @param {string} opts.equipmentList
 * @param {"fast"|"detailed"} [opts.mode]
 * @param {"single"|"plan"|"session"} [opts.step]
 * @param {Object} [opts.planJson] - krävs för step="session"
 * @param {number} [opts.targetSessionId] - krävs för step="session"
 */
export function buildWorkoutRequest({
  profile,
  sessionDuration,
  weekdayList,
  equipmentList,
  mode = "fast",
  step = "single",
  planJson,
  targetSessionId
}) {
  // Single-call läge: antingen ultrafast eller compact
  if (step === "single") {
    const variant = mode === "fast" ? "ultrafast" : "compact";
    const cfg = AI_CONFIG.single_call[variant];

    const system = cfg.system_prompt;
    const user = fillTemplate(cfg.user_prompt, {
      profile,
      sessionDuration,
      weekdayList: JSON.stringify(weekdayList),
      equipmentList
    });

    return {
      system,
      user,
      max_tokens: cfg.max_tokens,
      timeout_ms: cfg.timeout_ms,
      response_format: { type: "json_object" }
    };
  }

  // Multi-call, steg 1: planera veckan
  if (step === "plan") {
    const cfg = AI_CONFIG.multi_call.plan;

    const system = AI_CONFIG.multi_call.shared_system_prompt;
    const user = fillTemplate(cfg.user_prompt, {
      profile,
      sessionDuration,
      weekdayList: JSON.stringify(weekdayList),
      equipmentList
    });

    return {
      system,
      user,
      max_tokens: cfg.max_tokens,
      timeout_ms: cfg.timeout_ms,
      response_format: { type: "json_object" }
    };
  }

  // Multi-call, steg 2: generera ett specifikt pass
  if (step === "session") {
    if (!planJson || targetSessionId == null) {
      throw new Error("planJson och targetSessionId krävs för step='session'");
    }

    const cfg = AI_CONFIG.multi_call.session;

    const system = AI_CONFIG.multi_call.shared_system_prompt;
    const user = fillTemplate(cfg.user_prompt, {
      profile,
      sessionDuration,
      weekdayList: JSON.stringify(weekdayList),
      equipmentList,
      planJson: JSON.stringify(planJson),
      targetSessionId
    });

    return {
      system,
      user,
      max_tokens: cfg.max_tokens,
      timeout_ms: cfg.timeout_ms,
      response_format: { type: "json_object" }
    };
  }

  throw new Error(`Okänt step: ${step}`);
}

Hur du använder den i praktiken

Snabbt läge, single call:

const req = buildWorkoutRequest({
  profile,
  sessionDuration,
  weekdayList,
  equipmentList,
  mode: "fast",
  step: "single"
});

// req.system -> system prompt
// req.user   -> user prompt
// req.max_tokens, req.timeout_ms, req.response_format


Detaljerat läge, single call (mer struktur):

const req = buildWorkoutRequest({
  profile,
  sessionDuration,
  weekdayList,
  equipmentList,
  mode: "detailed",
  step: "single"
});


Multi-call: först plan, sedan ett pass:

// 1) Skapa veckoplan
const planReq = buildWorkoutRequest({
  profile,
  sessionDuration,
  weekdayList,
  equipmentList,
  step: "plan"
});

// ...anropa AI, parsa planJson...

// 2) Skapa detaljerat pass, t.ex. sessionId = 1
const sessionReq = buildWorkoutRequest({
  profile,
  sessionDuration,
  weekdayList,
  equipmentList,
  step: "session",
  planJson,
  targetSessionId: 1
});